{"version":3,"sources":["../../../lib/studio/ServerlessExec.js"],"names":["path","require","slsCommand","spawn","dependencyTree","execOptions","env","process","SLS_DEV_MODE","cwd","stdio","ServerlessExec","constructor","stage","region","deployToStage","deployToRegion","functionToFilenames","info","filenameToFunctions","trackedFiles","stdoutBuffer","output","JSON","parse","toString","e","functions","Object","keys","forEach","functionName","handler","dir","name","handlerEntry","join","list","toList","filename","directory","filter","indexOf","watchedFilename","funcs","Set","push","fetchEndpoints","endpoints","error","match","map","stringEndpoint","split","method","endpoint","console","deploy","deployArgs","splice","remove","invoke","invokeStudioEvent","payload","body","module","exports"],"mappings":"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","sourcesContent":["'use strict';\nconst path = require('path');\n\nconst slsCommand = 'serverless';\n\nconst spawn = require('child-process-ext/spawn');\n\nconst dependencyTree = require('dependency-tree');\n\nconst execOptions = {\n  env: {\n    ...process.env,\n    SLS_DEV_MODE: true,\n  },\n  cwd: process.cwd(),\n  stdio: 'inherit',\n};\n\nclass ServerlessExec {\n  constructor(stage, region) {\n    this.deployToStage = stage;\n    this.deployToRegion = region;\n    this.functionToFilenames = {};\n  }\n\n  async info() {\n    const filenameToFunctions = {};\n    const trackedFiles = [];\n\n    /**\n     * Issue the --info variant of this command to get a parsed JSON output\n     * of the serverless.yml to determine HTTP endpoints\n     */\n    const { stdoutBuffer } = await spawn(slsCommand, [\n      'studio',\n      '--info',\n      `--stage=${this.deployToStage}`,\n      `--region=${this.deployToRegion}`,\n    ]);\n\n    let output = {};\n\n    try {\n      output = JSON.parse(stdoutBuffer.toString());\n    } catch (e) {\n      /**\n       * If you ctrl+c during \"serverless dev --info\" to extract parsed\n       * yml information and HTTP endpoints, this will blow up. For now,\n       * just return some empty state objects so we can exit cleanly\n       * without an error.\n       */\n      return {\n        filenameToFunctions,\n        trackedFiles,\n        output,\n        functions: [],\n      };\n    }\n\n    const { functions } = output;\n\n    /**\n     * Use the handler path to reconstruct the path to the entry module\n     */\n    Object.keys(functions).forEach((functionName) => {\n      const { dir, name } = path.parse(functions[functionName].handler);\n      const handlerEntry = `${path.join(dir, name)}.js`;\n\n      /**\n       * Determine modules required by the entry point of the handler\n       */\n      const list = dependencyTree.toList({\n        filename: handlerEntry,\n        directory: process.cwd(),\n\n        /**\n         * Don't try to watch files in node_modules\n         */\n        filter: (filename) => filename.indexOf('node_modules') === -1,\n      });\n\n      /**\n       * Store all files that make up this function\n       */\n      this.functionToFilenames[functionName] = list;\n\n      /**\n       * For convenience, map all watched modules to function(s)\n       */\n      list.forEach((watchedFilename) => {\n        /**\n         * Functions already mapped to this file\n         */\n        const funcs = filenameToFunctions[watchedFilename] || [];\n\n        filenameToFunctions[watchedFilename] = new Set([...funcs, functionName]);\n      });\n\n      trackedFiles.push(...list);\n    });\n\n    return {\n      filenameToFunctions,\n      trackedFiles,\n      output,\n      functions,\n    };\n  }\n\n  async fetchEndpoints() {\n    let endpoints = [];\n\n    /**\n     * Close your eyes.\n     *\n     * Call 'serverless info' here to get the endpoints and pull them out of the output, if there are any.\n     */\n    let stdoutBuffer;\n    try {\n      ({ stdoutBuffer } = await spawn(slsCommand, [\n        'info',\n        `--stage=${this.deployToStage}`,\n        `--region=${this.deployToRegion}`,\n      ]));\n    } catch (error) {\n      /**\n       * If we fail, it's probably because this this stage is not\n       * yet deployed.\n       */\n      return endpoints;\n    }\n    try {\n      endpoints = stdoutBuffer\n        .toString()\n        .match(/(ANY|GET|POST|PUT|PATCH|HEAD|OPTIONS|DELETE) - (.*)/g)\n        .map((stringEndpoint) => {\n          const [method, endpoint] = stringEndpoint.split(' - ');\n\n          return {\n            method,\n            endpoint,\n          };\n        });\n    } catch (e) {\n      console.error('ERROR parsing \"serverless info\"'); // eslint-disable-line no-console\n    }\n    return endpoints;\n  }\n\n  async deploy(functionName) {\n    const deployArgs = [\n      'deploy',\n      `--stage=${this.deployToStage}`,\n      `--region=${this.deployToRegion}`,\n    ];\n    if (functionName) {\n      deployArgs.splice(1, 0, 'function', `--function=${functionName}`);\n    }\n    await spawn(slsCommand, deployArgs, execOptions);\n  }\n\n  async remove() {\n    await spawn(\n      slsCommand,\n      ['remove', `--stage=${this.deployToStage}`, `--region=${this.deployToRegion}`],\n      execOptions\n    );\n  }\n\n  async invoke(invokeStudioEvent) {\n    const { functionName, payload } = invokeStudioEvent;\n\n    await spawn(\n      slsCommand,\n      [\n        'invoke',\n        `--stage=${this.deployToStage}`,\n        `--region=${this.deployToRegion}`,\n        `--function=${functionName}`,\n        `--data=${payload.body}`,\n      ],\n      execOptions\n    );\n  }\n}\n\nmodule.exports = ServerlessExec;\n"],"file":"ServerlessExec.js"}